/*!
 * atomy - v0.1.1 -  3/9/2012
 *
 * https://github.com/cayasso/atomy
 * Copyright (c) 2012 Jonathan Brumley <cayasso@gmail.com>
 * Dual licensed under the MIT and GPL licenses.
 * Credits: Jonathan Brumley, John Resig, Jeremy Ashkenas
 */

(function(k){var g,h={},l=!1,m=Array.prototype.slice,q=Object.prototype.toString,n=Object.prototype.hasOwnProperty,r=0,s=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/,o=function(){};g="undefined"!==typeof exports?exports:this.Atomy={};g.VERSION="0.1.1";var e=this._,p=superagent;!e&&"undefined"!==typeof require&&(e=require("underscore"));!p&&"undefined"!==typeof require&&(p=require("superagent"));o.instances={};o.extend=function(a,b,c){function d(a,d,b){for(var c in a)d[c]="function"===typeof a[c]&&
"function"===typeof b[c]&&s.test(a[c])?function(a,d){return function(){var c=this._super,f;this._super=b[a];f=d.apply(this,arguments);this._super=c;return f}}(c,a[c]):a[c];return d}function f(d){if(this instanceof f){if(!l&&"function"===typeof this.init)return this._className=a,this._class=this.constructor,this.constructor._name=a.toLowerCase(),this.init.apply(this,d&&d.callee?d:arguments)}else return new f(arguments)}var j,i=this.prototype;"string"!==typeof a&&(c=b,b=a,a=null);c||(c=b,b=null);l=
!0;j=new this;l=!1;j=d(c,j,i);f.prototype=j;f.prototype.constructor=f;f.prototype.supperclass=this;for(var e in this)n.call(this,e)&&"prototype"!==e&&(f[e]=this[e]);f=d(b,f,this);f.extend=arguments.callee;a&&(f.className=a,f._name=a.toLowerCase());this.extended&&this.extended(f);a.toLowerCase();return f};g.Class=o;e.mixin({cid:function(a){return a||"C"+r++},isMatch:function(a,b){var c=0,d=0;this.each(b,function(b,j){var i=a[j];c+=1;e.isNumber(i)?i===b&&(d+=1):e.isString(i)?i&&null!==i.match(RegExp(b,
"i"))&&(d+=1):i==b&&(d+=1)});return d===c},isHash:function(a){return"[object Object]"===q.call(a)},curry:function(a,b){var c=m.call(arguments,2);return function(){a.apply(b||this,c.concat(m.call(arguments,0)))}},extend:function(a,b,c){var b=b||{},d;for(d in b)if(!c||!n.call(a,d))a[d]=b[d];return a},clone:function(a){function b(){}if(Object.create)return Object.create(a);b.prototype=a;a=new b;a.constructor=b;return a}});g.Events=function(){function a(a,b,c){for(var a=a.split(/\s+/),i,e=this._callbacks||
(this._callbacks={});i=a.shift();){i=e[i]||(e[i]={});var g=i.tail||(i.tail=i.next={});g.callback=b;g.context=c;i.tail=g.next={}}return this}function b(a,b,c){var e,g,h;if(a){if(g=this._callbacks)for(a=a.split(/\s+/);e=a.shift();)if(h=g[e],delete g[e],b&&h)for(;(h=h.next)&&h.next;)if(!(h.callback===b&&(!c||h.context===c)))this.on(e,h.callback,h.context)}else delete this._callbacks;return this}function c(a){var b,c,e,g;if(!(e=this._callbacks))return this;g=e.all;for((a=a.split(/\s+/)).push(null);b=
a.shift();)g&&a.push({next:g.next,tail:g.tail,event:b}),(c=e[b])&&a.push({next:c.next,tail:c.tail});for(g=m.call(arguments,1);c=a.pop();){b=c.tail;for(e=c.event?[c.event].concat(g):g;(c=c.next)!==b;)c.callback.apply(c.context||this,e)}return this}return function(){this.on=a;this.off=b;this.trigger=c;return this}}();g.List=function(){function a(a){return h[this._name][a]||null}function b(a){var b=0,c=h[this._name],d;for(d in c)if(n.call(c,d)&&b++===a)return c[d]}function c(){return this.index(0)}function d(){var a=
e.size(h[this._name]);return 0<a?this.index(a-1):!1}return function(){this.first=c;this.last=d;this.getById=a;this.index=b;return this}}();g.Model=g.Class.extend("Model",{methodMaps:{create:"POST",read:"GET",update:"PUT",destroy:"DELETE"},idAttribute:"id",schema:[],connection:{},collection:{},errors:{},initialize:function(){},errorMessages:{missingSchemaDataType:"Missing schema data type",missingQueryParameter:"Missing query parameter",missingModel:"Model object is missing, please pass a model object.",
missingBaseUrl:"getURL: Missing baseURL or uri values in extend file",invalidEnum:"Invalid listed value",required:"Field is required",typeMismatch:"Data type mismatch",invalidModelName:"Invalid model name",invalidServerResponse:"Invalid server response type, is not a JSON object",validationFail:"Validation failed"},find:function(a,b){var c;e.isHash(a)||(c="all"!==a?a:null,a={});return this._request({id:c,data:a,action:"read"},b)},findOnClient:function(a,b){!e.isHash(a)&&(a={id:a});var c=[],d=0,f,
g,i=this.records();for(g in a)d+=1;if(e.isEmpty(i))return e.isFunction(b)&&b([],f),c;if("all"===a.id)c=i;else{if(e.isEmpty(a))throw this.errorMessages.misingQueryParameter;for(g in i){var h=i[g];if(e.isMatch(h,a)&&(c.push(h),1===d&&!e.isUndefined(a.id))){f=g;break}}}e.isFunction(b)&&b(c,f);return c},create:function(a,b){return this(a).save(b)},update:function(a,b,c,d){var f={};e.isHash(a)&&(c=b,b=a,a=b[this.idAttribute]);d&&(e.each(b,function(a,b){d._.data?d._.data[b]!==a&&(f[b]=a):f[b]=a}),b=f);
return this._request({data:b,action:"update",model:d,id:a},c)},destroy:function(a,b,c){return this._request({action:"destroy",model:c,id:a},b)},sync:function(a,b){return p(this.methodMaps[a.action],this._getURL(a.id)).send(a.data||{}).end(e.curry(this._callback,this,a,b))},records:function(){return h[this._name]},clearRecords:function(){delete h[this._name];return h[this._name]={}},_request:function(a,b){var c;if(a.model&&"update"===a.action){var d=a.model,f={};d._updateFields("",a.data);f=d._diff(d._.data);
d._updateFields("update",f);d.trigger("update",d,f)}return a.model&&this.validate&&(c=a.model._validate())?(d={errors:c,error:!0,ok:!1},a.model.trigger("error",a.model,c),e.isFunction(b)&&b.call(this,d)||d):this.sync(a,b)},_callback:function(a,b,c){c&&c.body&&!a.model?c.body=this._toModel(a.data):c={body:a.model};this._sync(a.action,c.body,a);return e.isFunction(b)&&b.call(this,c)||c},_sync:function(a,b,c){var d=this._name,f=e.isArray(b)&&b,c=c[this.idAttribute]||b[this.idAttribute];h[d]=h[d]||{};
f?"read"===a&&e.each(f,function(a){h[d][a[a.idAttribute]]=a}):"destroy"===a?(h[d][c]&&delete h[d][c],b.trigger(a,b)):this.methodMaps[a]&&(h[d][b[this.idAttribute]]=b)},_getURL:function(a){return[this.connection.host||this._getHost(),this.connection.key,a&&"/"+a||"",e.isUndefined(this.connection.ext)?"":this.connection.ext].join("")},_getHost:function(){return location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")+"/"},_toModel:function(a){var b=[],c,d;if(e.isArray(a)){c=0;for(d=
a.length;c<d;c+=1)b[c]=this._toModel(a[c])}else b=this(a)._loadServerData(),b._isNew=!1;return b}},{init:function(a,b){var c=this._class.schema,d=this.idAttribute=this._class.idAttribute;this._escapedFields={};c&&!c[d]&&this._class.schema.push(d);this._={data:{}};this.connection=this._class.connection;this._isNew=!0;this._name=this._class._name;this._class.initialize.call(this,b);a&&this._updateFields("create",a);!this[d]&&(this[d]=e.cid());return this},_onModelEvent:function(){},save:function(a){a=
this[this.isNew()?"create":"update"](a);this.trigger("save",this);return a},create:function(a){this._loadServerData();this._isNew=!1;return this._class._request({action:"create",model:this},a)},update:function(a,b){e.isFunction(a)&&(b=a);return this._class.update(this[this.idAttribute],a,b,this)},destroy:function(a){return this._class.destroy(this[this.idAttribute],a,this)},clone:function(){return e.clone(this)},clear:function(){var a,b,c={},d={},f,g;if(a=this._class.schema){f=0;for(g=a.length;f<
g;f++)b=a[f],this[b]!==k&&(d[b]=this[b],c[b]=k,delete this[b])}e.isEmpty(c)||this.trigger("change",this,d,c);return this},isNew:function(){return this._isNew},isValid:function(){return!this._validate()},_validate:function(){var a,b=this._class.validate;(a=b&&b.call(this))&&this.trigger("error",this,a);return a},toJSON:function(a){var b,c=this._class.schema,d,f;a||(a={});d=0;for(f=c.length;d<f;d++)b=c[d],a[b]=this[b];return a},escape:function(a){a=this[a];return e.escape(null===a?"":""+a)},_loadServerData:function(){var a=
this._class.schema,b,c,d;if(a){b=0;for(d=a.length;b<d;b++)c=a[b],this[c]!==k&&!e.isEqual(this[c],this._.data[c])&&(this._.data[c]=this[c])}return this},_updateFields:function(a,b){var c=this._class.schema,d,f,e;if(c&&b){d=0;for(e=c.length;d<e;d++)f=c[d],b[f]!==k&&(this[f]=b[f],"update"===a&&(this.trigger("change:"+f,this,this[f],this._.data[f]),this._.data[f]=b[f]))}return this},_diff:function(a){var b=this._class.schema,c,d,f,g={};if(!a)return null;c=0;for(f=b.length;c<f;c++)d=b[c],this.hasOwnProperty(d)&&
(d in this?e.isEqual(a[d],this[d])||(g[d]=this[d]):g[d]=k),d in a||(g[d]=this[d]);return g}});e.each("forEach,each,map,reduce,reduceRight,find,filter,reject,every,any,include,invoke,max,min,sortBy,sortedIndex,toArray,size,initial,rest,shuffle,isEmpty,groupBy".split(","),function(a){g.Model[a]=function(){return e[a].apply(e,[h[this._name]])}});g.List.call(g.Model);g.Events.call(g.Model);g.Events.call(g.Model.prototype);return g}).call(this);