/*!
 * atomy - v0.1.1 -  3/9/2012
 *
 * https://github.com/cayasso/atomy
 * Copyright (c) 2012 Jonathan Brumley <cayasso@gmail.com>
 * Dual licensed under the MIT and GPL licenses.
 * Credits: Jonathan Brumley, John Resig, Jeremy Ashkenas
 */
(function(a){var b=this,c,d={},e=!1,f={},g=Array.prototype.slice,h=Object.prototype.toString,i=Object.prototype.hasOwnProperty,j=0,k=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/,l=function(){};typeof exports!="undefined"?c=exports:c=b.Atomy={},c.VERSION="0.1.1";var m=b._,n=superagent;return!m&&typeof require!="undefined"&&(m=require("underscore")),!n&&typeof require!="undefined"&&(n=require("superagent")),l.instances={},l.extend=function(a,b,c){function j(a,b,c){var d;for(d in a)b[d]=typeof a[d]=="function"&&typeof c[d]=="function"&&k.test(a[d])?function(a,b){return function(){var d=this._super,e;return this._super=c[a],e=b.apply(this,arguments),this._super=d,e}}(d,a[d]):a[d];return b}function l(b){if(!(this instanceof l))return new l(arguments);if(!e&&typeof this.init=="function")return this._className=a,this._class=this.constructor,this.constructor._name=a.toLowerCase(),this.init.apply(this,b&&b.callee?b:arguments)}var d,g=this,h=this.prototype;typeof a!="string"&&(c=b,b=a,a=null),c||(c=b,b=null),e=!0,d=new this,e=!1,d=j(c,d,h),l.prototype=d,l.prototype.constructor=l,l.prototype.supperclass=g;for(var m in this)i.call(this,m)&&m!=="prototype"&&(l[m]=this[m]);return l=j(b,l,g),l.extend=arguments.callee,a&&(l.className=a,l._name=a.toLowerCase()),g.extended&&g.extended(l),f[a.toLowerCase()]=l,l},c.Class=l,m.mixin({cid:function(a){return a||"C"+j++},isMatch:function(a,b){var c=0,d=0;return this.each(b,function(b,e){var f=a[e];c+=1,m.isNumber(f)?f===b&&(d+=1):m.isString(f)?f&&f.match(new RegExp(b,"i"))!==null&&(d+=1):f==b&&(d+=1)}),d===c},isHash:function(a){return"[object Object]"===h.call(a)},curry:function(a,b){var c=g.call(arguments,2);return function(){a.apply(b||this,c.concat(g.call(arguments,0)))}},extend:function(a,b,c){var d=b||{},e;for(e in d)if(!c||!i.call(a,e))a[e]=d[e];return a},clone:function(a){function b(){}if(Object.create)return Object.create(a);b.prototype=a;var c=new b;return c.constructor=b,c}}),c.Events=function(){function a(a,b,c){a=a.split(/\s+/);var d,e=this._callbacks||(this._callbacks={});while(d=a.shift()){var f=e[d]||(e[d]={}),g=f.tail||(f.tail=f.next={});g.callback=b,g.context=c,f.tail=g.next={}}return this}function b(a,b,c){var d,e,f;if(!a)delete this._callbacks;else if(e=this._callbacks){a=a.split(/\s+/);while(d=a.shift()){f=e[d],delete e[d];if(!b||!f)continue;while((f=f.next)&&f.next)if(f.callback!==b||!!c&&f.context!==c)this.on(d,f.callback,f.context);else continue}}return this}function c(a){var b,c,d,e,f,h,i;if(!(d=this._callbacks))return this;h=d.all,(a=a.split(/\s+/)).push(null);while(b=a.shift()){h&&a.push({next:h.next,tail:h.tail,event:b});if(!(c=d[b]))continue;a.push({next:c.next,tail:c.tail})}i=g.call(arguments,1);while(c=a.pop()){e=c.tail,f=c.event?[c.event].concat(i):i;while((c=c.next)!==e)c.callback.apply(c.context||this,f)}return this}return function(){return this.on=a,this.off=b,this.trigger=c,this}}(),c.List=function(){function a(a){return d[this._name][a]||null}function b(a){var b=0,c=d[this._name];for(var e in c)if(i.call(c,e)&&b++===a)return c[e]}function c(){return this.index(0)}function e(){var a=d[this._name],b=m.size(a);return b>0?this.index(b-1):!1}return function(){return this.first=c,this.last=e,this.getById=a,this.index=b,this}}(),c.Model=c.Class.extend("Model",{methodMaps:{create:"POST",read:"GET",update:"PUT",destroy:"DELETE"},idAttribute:"id",schema:[],connection:{},collection:{},errors:{},initialize:function(){},errorMessages:{missingSchemaDataType:"Missing schema data type",missingQueryParameter:"Missing query parameter",missingModel:"Model object is missing, please pass a model object.",missingBaseUrl:"getURL: Missing baseURL or uri values in extend file",invalidEnum:"Invalid listed value",required:"Field is required",typeMismatch:"Data type mismatch",invalidModelName:"Invalid model name",invalidServerResponse:"Invalid server response type, is not a JSON object",validationFail:"Validation failed"},find:function(a,b){var c;return m.isHash(a)||(c=a!=="all"?a:null,a={}),this._request({id:c,data:a,action:"read"},b)},findOnClient:function(a,b){!m.isHash(a)&&(a={id:a});var c=[],d=0,e,f,g=this.records();for(f in a)d+=1;if(m.isEmpty(g))return m.isFunction(b)&&b([],e),c;if(a.id==="all")c=g;else{if(!!m.isEmpty(a))throw this.errorMessages.misingQueryParameter;for(f in g){var h=g[f];if(m.isMatch(h,a)){c.push(h);if(d===1&&!m.isUndefined(a.id)){e=f;break}}}}return m.isFunction(b)&&b(c,e),c},create:function(a,b){return this(a).save(b)},update:function(a,b,c,d){var e={};return m.isHash(a)&&(c=b,b=a,a=b[this.idAttribute]),d&&(m.each(b,function(a,b){d._.data?d._.data[b]!==a&&(e[b]=a):e[b]=a}),b=e),this._request({data:b,action:"update",model:d,id:a},c)},destroy:function(a,b,c){return this._request({action:"destroy",model:c,id:a},b)},sync:function(a,b){var c=n(this.methodMaps[a.action],this._getURL(a.id)).send(a.data||{}).end(m.curry(this._callback,this,a,b));return c},records:function(){return d[this._name]},clearRecords:function(){return delete d[this._name],d[this._name]={}},_request:function(a,b){var c,d;if(a.model&&a.action==="update"){var e=a.model,f={};e._updateFields("",a.data),f=e._diff(e._.data),e._updateFields("update",f),e.trigger("update",e,f)}if(a.model&&this.validate&&(d=a.model._validate())){var g={errors:d,error:!0,ok:!1};return a.model.trigger("error",a.model,d),m.isFunction(b)&&b.call(this,g)||g}return this.sync(a,b)},_callback:function(a,b,c){return c&&c.body&&!a.model?c.body=this._toModel(a.data):c={body:a.model},this._sync(a.action,c.body,a),m.isFunction(b)&&b.call(this,c)||c},_sync:function(a,b,c){var e=this._name,f=m.isArray(b)&&b,g=c[this.idAttribute]||b[this.idAttribute];d[e]=d[e]||{},f?a==="read"&&m.each(f,function(a){d[e][a[a.idAttribute]]=a}):a==="destroy"?(d[e][g]&&delete d[e][g],b.trigger(a,b)):this.methodMaps[a]&&(d[e][b[this.idAttribute]]=b)},_getURL:function(a){return[this.connection.host||this._getHost(),this.connection.key,a&&"/"+a||"",m.isUndefined(this.connection.ext)?"":this.connection.ext].join("")},_getHost:function(){return location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")+"/"},_toModel:function(a){var b=[],c,d;if(m.isArray(a))for(c=0,d=a.length;c<d;c+=1)b[c]=this._toModel(a[c]);else b=this(a)._loadServerData(),b._isNew=!1;return b}},{init:function(a,b){var c=this._class.schema,d=this.idAttribute=this._class.idAttribute;return this._escapedFields={},c&&!c[d]&&this._class.schema.push(d),this._={data:{}},this.connection=this._class.connection,this._isNew=!0,this._name=this._class._name,this._class.initialize.call(this,b),a&&this._updateFields("create",a),!this[d]&&(this[d]=m.cid()),this},_onModelEvent:function(a,b,c){},save:function(a){var b=this[this.isNew()?"create":"update"](a);return this.trigger("save",this),b},create:function(a){return this._loadServerData(),this._isNew=!1,this._class._request({action:"create",model:this},a)},update:function(a,b){return m.isFunction(a)&&(b=a),this._class.update(this[this.idAttribute],a,b,this)},destroy:function(a){return this._class.destroy(this[this.idAttribute],a,this)},clone:function(){return m.clone(this)},clear:function(){var b,c,d={},e={},f,g;if(b=this._class.schema)for(f=0,g=b.length;f<g;f++)c=b[f],this[c]!==a&&(e[c]=this[c],d[c]=a,delete this[c]);return m.isEmpty(d)||this.trigger("change",this,e,d),this},isNew:function(){return this._isNew},isValid:function(){return!this._validate()},_validate:function(){var a,b=this._class.validate;return(a=b&&b.call(this))&&this.trigger("error",this,a),a},toJSON:function(a){var b,c=this._class.schema,d,e;a||(a={});for(d=0,e=c.length;d<e;d++)b=c[d],a[b]=this[b];return a},escape:function(a){var b=this[a];return m.escape(b===null?"":""+b)},_loadServerData:function(){var b=this._class.schema,c,d,e;if(b)for(c=0,e=b.length;c<e;c++)d=b[c],this[d]!==a&&!m.isEqual(this[d],this._.data[d])&&(this._.data[d]=this[d]);return this},_updateFields:function(b,c){var d=this._class.schema,e,f,g;if(d&&c)for(e=0,g=d.length;e<g;e++)f=d[e],c[f]!==a&&(this[f]=c[f],b==="update"&&(this.trigger("change:"+f,this,this[f],this._.data[f]),this._.data[f]=c[f]));return this},_diff:function(b){var c=this._class.schema,d,e,f,g={};if(!b)return null;for(d=0,f=c.length;d<f;d++)e=c[d],this.hasOwnProperty(e)&&(e in this?m.isEqual(b[e],this[e])||(g[e]=this[e]):g[e]=a),e in b||(g[e]=this[e]);return g}}),m.each(["forEach","each","map","reduce","reduceRight","find","filter","reject","every","any","include","invoke","max","min","sortBy","sortedIndex","toArray","size","initial","rest","shuffle","isEmpty","groupBy"],function(a){c.Model[a]=function(){return m[a].apply(m,[d[this._name]])}}),c.List.call(c.Model),c.Events.call(c.Model),c.Events.call(c.Model.prototype),c}).call(this)

