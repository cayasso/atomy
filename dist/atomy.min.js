/*!
 * atomy - v0.1.4 -  3/22/2012
 *
 * https://github.com/cayasso/atomy
 * Copyright (c) 2012 Jonathan Brumley <cayasso@gmail.com>
 * Dual licensed under the MIT and GPL licenses.
 * Credits: Jonathan Brumley, John Resig, Jeremy Ashkenas
 */
(function(a,b,c){"use strict";var d=this,e,f={},g=!1,h={},i=Array.prototype.slice,j=Object.prototype.toString,k=Object.prototype.hasOwnProperty,l=0,m=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/,n=function(){};typeof exports!="undefined"?e=exports:e=d.Atomy={},e.VERSION="0.1.4";var o=d._,p=superagent;!o&&typeof require!="undefined"&&(o=require("underscore")),!p&&typeof require!="undefined"&&(p=require("superagent")),n.instances={},n.extend=function w(a,b,c){function i(a,b,c){var d;for(d in a)b[d]=typeof a[d]=="function"&&typeof c[d]=="function"&&m.test(a[d])?function(a,b){return function(){var d=this._super,e;return this._super=c[a],e=b.apply(this,arguments),this._super=d,e}}(d,a[d]):a[d];return b}function j(b){if(!(this instanceof j))return new j(arguments);if(!g&&typeof this.init=="function")return this._className=a,this._class=this.constructor,this.constructor._name=a.toLowerCase(),this.init.apply(this,b&&j?b:arguments)}var d,e=this,f=this.prototype;typeof a!="string"&&(c=b,b=a,a=null),c||(c=b,b=null),g=!0,d=new this,g=!1,d=i(c,d,f),j.prototype=d,j.prototype.constructor=j,j.prototype.supperclass=e;for(var l in this)k.call(this,l)&&l!=="prototype"&&(j[l]=this[l]);return j=i(b,j,e),j.extend=w,a&&(j.className=a,j._name=a.toLowerCase()),e.extended&&e.extended(j),h[a.toLowerCase()]=j,j},e.Class=n,o.mixin({cid:function(a){return a||"C"+l++},isMatch:function(a,b){var c=0,d=0;return this.each(b,function(b,e){var f=a[e];c+=1,o.isNumber(f)?f===b&&(d+=1):o.isString(f)?f&&f.match(new RegExp(b,"i"))!==null&&(d+=1):f==b&&(d+=1)}),d===c},isHash:function(a){return"[object Object]"===j.call(a)},curry:function(a,b){var c=i.call(arguments,2);return function(){a.apply(b||this,c.concat(i.call(arguments,0)))}},extend:function(a,b,c){var d=b||{},e;for(e in d)if(!c||!k.call(a,e))a[e]=d[e];return a},clone:function(a){function b(){}if(Object.create)return Object.create(a);b.prototype=a;var c=new b;return c.constructor=b,c}}),e.Events=function(){function a(a,b,c){a=a.split(/\s+/);var d,e=this._callbacks||(this._callbacks={});while(d=a.shift()){var f=e[d]||(e[d]={}),g=f.tail||(f.tail=f.next={});g.callback=b,g.context=c,f.tail=g.next={}}return this}function b(a,b,c){var d,e,f;if(!a)delete this._callbacks;else if(e=this._callbacks){a=a.split(/\s+/);while(d=a.shift()){f=e[d],delete e[d];if(!b||!f)continue;while((f=f.next)&&f.next)if(f.callback!==b||!!c&&f.context!==c)this.on(d,f.callback,f.context);else continue}}return this}function c(a){var b,c,d,e,f,g,h;if(!(d=this._callbacks))return this;g=d.all,(a=a.split(/\s+/)).push(null);while(b=a.shift()){g&&a.push({next:g.next,tail:g.tail,event:b});if(!(c=d[b]))continue;a.push({next:c.next,tail:c.tail})}h=i.call(arguments,1);while(c=a.pop()){e=c.tail,f=c.event?[c.event].concat(h):h;while((c=c.next)!==e)c.callback.apply(c.context||this,f)}return this}return function(){return this.on=a,this.off=b,this.trigger=c,this}}(),e.List=function(){function a(a){return f[this._name][a]||null}function b(a){var b=0,c=f[this._name];for(var d in c)if(k.call(c,d)&&b++===a)return c[d]}function c(){return this.index(0)}function d(){var a=f[this._name],b=o.size(a);return b>0?this.index(b-1):!1}return function(){return this.first=c,this.last=d,this.iD=a,this.index=b,this}}(),e.Model=e.Class.extend("Model",{_methods:{create:"POST",read:"GET",update:"PUT",destroy:"DELETE"},ajaxProvider:"superagent",fakeJSON:!1,fakeHTTP:!1,_getMethod:function(a){if(this.fakeHTTP)if(a==="update"||a==="destroy")return"POST";return this._methods[a]},idAttribute:"id",schema:[],connection:{},collection:{},errors:{},initialize:function(){},find:function(a,b){var c;return o.isHash(a)||(c=a!=="all"?a:null,a={}),this._crud({id:c,data:a,action:"read"},b)},findOnClient:function(a,b){!o.isHash(a)&&(a={id:a});var c=[],d=0,e,f,g=this.records();for(f in a)d+=1;if(o.isEmpty(g))return o.isFunction(b)&&b([],e),c;if(a.id==="all")c=g;else{if(!!o.isEmpty(a))throw new Error("Atomy.findOnClient: Missing query parameter");for(f in g){var h=g[f];if(o.isMatch(h,a)){c.push(h);if(d===1&&!o.isUndefined(a.id)){e=f;break}}}}return o.isFunction(b)&&b(c,e),c},create:function(a,b){return this(a).save(b)},update:function(a,b,c,d){var e,f;d=this.model||null,o.isHash(a)&&(c=b,b=a,a=b[this.idAttribute]);if(d)for(e in b)f=b[e],d._.data&&d._.data[e]!==f&&(b[e]=f);return console.log("UPDATE ====> ",this.model),this._crud({data:b,action:"update",model:d,id:a},c)},destroy:function(a,b,c){return this._crud({action:"destroy",model:c,id:a},b)},sync:function(a,b){return this.request({url:this._getURL(a.id),type:this._getMethod(a.action),data:this.fakeHTTP?o.extend(a.data,{_method:this._getMethod(a.action)},!0):a.data||{},success:o.curry(this._callback,this,a,b),error:o.curry(this._callback,this,{},b),dataType:"json"},this.fakeJSON,a.action)},request:function(a,b,c){var d=this,e={zepto:"$",jquery:"$",superagent:"superagent"}[this.ajaxProvider];if(!e)throw new Error("Atomy.request: Invalid Ajax provider");return{superagent:function(){return p(a.type,a.url).type(b?"form-data":a.dataType).send(a.data).end(a.success)},$:function(){return a.beforeSend=function(a){b&&a.setRequestHeader("X-HTTP-Method-Override",d._methods[c])},$.ajax(a)}}[e]()},records:function(){return f[this._name]},clearRecords:function(){return delete f[this._name],f[this._name]={}},_crud:function(a,b){var c,d;if(a.model&&a.action==="update"){var e={};a.model._updateFields("",a.data),a.data=e=a.model._diff(a.model._.data),a.model._updateFields("update",e),a.model.trigger("update",a.model,e)}if(a.model&&this.validate&&(d=a.model._validate())){var f={errors:d,error:!0,ok:!1};return a.model.trigger("error",a.model,d),o.isFunction(b)&&b.call(this,f)||f}return this.sync(a,b)},_callback:function(a,b,c,d,e){console.log("_CALLBACK",c);var f={},g=this.ajaxProvider==="superagent",h=g&&c&&c.body,i=d==="error",j=h?c.body:c;return a.model&&h&&(f=c),f.doc=i?{}:a.model?o.extend(a.model,j):this._toModel(j),h&&delete c.body,this._sync(a.action,f.doc,a),o.isFunction(b)&&b.call(this,this._status(f,g||(i?e.status:c.status)))||f},_sync:function(a,b,c){var d=this._name,e=o.isArray(b)&&b,g=c[this.idAttribute]||b[this.idAttribute];f[d]=f[d]||{},e?a==="read"&&o.each(e,function(a){f[d][a[a.idAttribute]]=a}):a==="destroy"?(f[d][g]&&delete f[d][g],b.trigger(a,b)):this._getMethod(c.action)&&(f[d][b[this.idAttribute]]=b)},_status:function(a,b){if(this.ajaxProvider==="superagent")return a;var c=b/100|0;return a.status=b,a.statusType=c,a.info=1==c,a.ok=2==c,a.clientError=4==c,a.serverError=5==c,a.error=4==c||5==c,a.accepted=202==b,a.noContent=204==b||1223==b,a.badRequest=400==b,a.unauthorized=401==b,a.notAcceptable=406==b,a.notFound=404==b,a},_getURL:function(a){return[this.connection.host||this._getHost(),this.connection.key,a&&"/"+a||"",o.isUndefined(this.connection.ext)?"":this.connection.ext].join("")},_getHost:function(){return location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")+"/"},_toModel:function(a){var b=[],c,d;if(o.isArray(a))for(c=0,d=a.length;c<d;c+=1)b[c]=this._toModel(a[c]);else b=this(a)._loadServerData(),b._isNew=!1;return b}},{init:function(a,b){var c=this.idAttribute=this._class.idAttribute;return this._escapedFields={},this._class.schema.indexOf(c)===-1&&this._class.schema.push(c),this._={data:{}},this.connection=this._class.connection,this._isNew=!0,this._name=this._class._name,this._class.initialize.call(this,b),a&&this._updateFields("create",a),!this[c]&&(this[c]=o.cid()),this._class.model=this,this},save:function(a){return this[this.isNew()?"create":"update"](a,null,this.trigger("save",this))},create:function(a){return this._loadServerData(),this._isNew=!1,this._class._crud({action:"create",model:this,data:this._.data},a)},update:function(a,b){return o.isFunction(a)&&(b=a),this._class.update(this[this.idAttribute],a,b,this)},destroy:function(a){return this._class.destroy(this[this.idAttribute],a,this)},clone:function(){return o.clone(this)},clear:function(){var a=this._class.schema,b,d,e=d={};if(a)for(var f=0,g=a.length;f<g;f++)b=a[f],this[b]!==c&&(d[b]=this[b],e[b]=c,delete this[b]);return o.isEmpty(e)||this.trigger("change",this,d,e),this},isNew:function(){return this._isNew},isValid:function(){return!this._validate()},toJSON:function(a){var b,c=this._class.schema,d,e;a||(a={});for(d=0,e=c.length;d<e;d++)b=c[d],a[b]=this[b];return a},escape:function(a){return o.escape(this[a]===null?"":""+this[a])},_validate:function(){var a,b=this._class.validate;return(a=b&&b.call(this))&&this.trigger("error",this,a),a},_loadServerData:function(){var a=this._class.schema,b,d,e=a.length;for(b=0,e=a.length;b<e;b++)d=a[b],this[d]!==c&&!o.isEqual(this[d],this._.data[d])&&(this._.data[d]=this[d]);return this},_updateFields:function(a,b){var d=this._class.schema,e,f,g=d.length;if(d&&b)for(e=0;e<g;e++)f=d[e],b[f]!==c&&(this[f]=b[f],a==="update"&&(this.trigger("change:"+f,this,this[f],this._.data[f]),this._.data[f]=b[f]));return this},_diff:function(a){if(!a)return null;var b=this._class.schema,d,e,f,g={};for(d=0,f=b.length;d<f;d++)e=b[d],this.hasOwnProperty(e)&&(e in this?o.isEqual(a[e],this[e])||(g[e]=this[e]):g[e]=c),e in a||(g[e]=this[e]);return g}}),o.each(["forEach","each","map","reduce","reduceRight","filter","reject","every","any","include","invoke","max","min","sortBy","sortedIndex","toArray","size","initial","rest","shuffle","isEmpty","groupBy"],function(a){e.Model[a]=function(){return o[a].apply(o,[f[this._name]])}}),e.View=e.Class.extend("View",{tag:"div",className:"",template:o.template(),events:{".check":function(){}}},{init:function(a){},render:function(){}});var q=/msie [\w.]+/,r=!1,s=b.documentMode,t=q.exec(navigator.userAgent.toLowerCase())&&(!s||s<=7),u=a.location,v="";return e.Router=e.Class.extend("Router",{options:{root:"",interval:50,history:!1,fallback:!0,hashbang:!0,listen:!0},routes:{}},{init:function(b){b=o.extend(e.Router.options,this._class.options),this._ids={},this._routes={},this.map(this._class.routes),this._hashbang=b.hashbang,this._fallback=b.fallback,this._hasPushState=!!a.history&&!!a.history.pushState,this._hasPushState=!1,b.listen&&this.listen()},listen:function(){var b=this,c=function(a){var c=b.fragment();c!==v&&(b._check(c),v=c)};this._hasPushState?a.onpopstate=c:this._fallback&&("onhashchange"in a&&!t?a.onhashchange=c:this._intervalTimer=setInterval(c,this._class.options.interval))},fragment:function(a){return this._hasPushState?u.pathname:this.hash()},hash:function(a){var b=a?a.location:u,c=b.href.match(/#!?(.*)$/);return c?c[1]:""},map:function(a,b){if(o.isHash(a))for(var c in a)this.map(c,a[c]);else{var d=a.split(" ");this._routes[d[0]]=b,d[1]&&(this._ids[d[1]]=d[0])}return this},navigate:function(a,b){return b===!0&&(b={trigger:!0}),this._pushState(a),b.trigger&&this._check(a),this},_pushState:function(a){this._hasPushState?history.pushState(null,null,a):this._fallback&&(u.hash="#"+(this._hashbang?"!":"")+a)},_check:function(a){var b,c;for(b in this._routes){c=this._routes[b],o.isString(c)&&(c=this._class[c]);if(this._run(b,a,c))break}},_run:function(a,b,c){var d=[],e,a=this._regex(a,d).exec(b);return c&&(e=a?this._params(d,a):null)?((o.isString(c)&&this._class[c]||c).call(this,e.obj,e),!0):!1},_regex:function(a,b,c){return a=a.concat(c?"":"/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(a,c,d,e,f,g){return b.push({name:e,optional:!!g}),c=c||"",""+(g?"":c)+"(?:"+(g?c:"")+(d||"")+(f||d&&"([^/.]+?)"||"([^/]+?)")+")"+(g||"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)"),new RegExp("^"+a+"$")},_params:function(a,b){var c,d={path:b[0],names:a,values:b,obj:{}};for(c=1,len=b.length;c<len;c++)d.obj[a[c-1].name]=b[c];return d}}),e.List.call(e.Model),e.Events.call(e.Model),e.Events.call(e.Model.prototype),e}).call(this,window,document)