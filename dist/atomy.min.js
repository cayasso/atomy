/*!
 * atomy - v0.1.5 -  6/10/2012
 *
 * https://github.com/cayasso/atomy
 * Copyright (c) 2012 Jonathan Brumley <cayasso@gmail.com>
 * Dual licensed under the MIT and GPL licenses.
 * Credits: Jonathan Brumley, John Resig, Jeremy Ashkenas
 */
(function(a,b,c){"use strict";var d=this,e,f={},g=!1,h={},i=Array.prototype.slice,j=Object.prototype.toString,k=Object.prototype.hasOwnProperty,l=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;typeof exports!="undefined"?e=exports:e=d.Atomy={},e.VERSION="0.1.4",e.enableGlobals=!0,e.enableTestMode=!1,e.ajaxProvider="superagent";var m=d._,n=d.superagent;!m&&typeof require!="undefined"&&(m=require("underscore")),!n&&typeof require!="undefined"&&(n=require("superagent"));var o=function(){};o.instances={},o.setup=function(){return arguments.length&&arguments||[]},o.extend=function x(a,b,c){function r(a,b,c){var d;for(d in a)b[d]=m.isFunction(a[d])&&m.isFunction(c[d])&&l.test(a[d])?function(a,b){return function(){var d=this._super,e;return this._super=c[a],e=b.apply(this,arguments),this._super=d,e}}(d,a[d]):a[d]}function s(b){if(!(this instanceof s))return new s(arguments);if(!g&&m.isFunction(this.setup))return this._class=this.constructor,this._className=a,this.constructor._name=a.toLowerCase(),this.instance.apply(this,b&&m.isArguments(b)&&s?b:arguments)}var d,f,i=this,j=this.prototype,n,p,q;m.isString(a)||(c=b,b=a,a=null),c||(c=b,b=null),g=!0,d=new this,g=!1,r(c||{},d,j),s.prototype=d,s.prototype.constructor=s,s.prototype.supperclass=i,s.prototype.instance=function(){var a;return this.setup&&(a=this.setup.apply(this,arguments)),this.init&&this.init.apply(this,m.isArray(a)?a:arguments),this};for(var t in this)k.call(this,t)&&t!=="prototype"&&(s[t]=this[t]);r(b,s,i),s.extend=x;if(!a)throw new Error("Class name is required please provide one");var u=a;q=a.split(/\./),a=q.pop(),s.className=a,s._name=a.toLowerCase();if(h[a]&&!e.enableTestMode)throw new Error('Class name "'+a+'" already exist, try another name');return h[a]=s,e.enableGlobals&&!e.enableTestMode&&m.setObject(u,s),i.extended&&i.extended(o),f=s.setup.apply(s,[i].concat(arguments)),s.init&&s.init.apply(s,f||[i].concat(arguments)),s},e.Class=o,m.mixin({cid:function(){return m.uniqueId("C")},isMatch:function(a,b){function e(b,e){var f=a[e];c+=1,m.isNumber(f)?f===b&&(d+=1):m.isString(f)?f&&f.match(new RegExp(b,"i"))!==null&&(d+=1):f==b&&(d+=1)}var c=0,d=0;return this.each(b,e),d===c},isHash:function(a){return"[object Object]"===j.call(a)},curry:function(a,b){var c=i.call(arguments,2);return function(){a.apply(b||this,c.concat(i.call(arguments,0)))}},extend:function(a,b,c){var d=b||{},e;for(e in d)if(!c||!k.call(a,e))a[e]=d[e];return a},clone:function(a){function b(){}if(Object.create)return Object.create(a);b.prototype=a;var c=new b;return c.constructor=b,c},setObject:function(a,b,d){var e=a.split("."),f=e.pop(),g=m.getObject(e,!0,d);return g&&typeof g=="object"&&f?g[f]=b:c},getObject:function(a,b,e){var f;m.isString(a)&&(a=a.split(".")),m.isBoolean(b)||(e=b,b=c),e=e||d;while(e&&a.length)f=a.shift(),e[f]===c&&b&&(e[f]={}),e=e[f];return e},exists:function(){return m.getObject(name,context)!==c}}),e.Events=function(){function a(a,b,c){a=a.split(/\s+/);var d,e=this._callbacks||(this._callbacks={});while(d=a.shift()){var f=e[d]||(e[d]={}),g=f.tail||(f.tail=f.next={});g.callback=b,g.context=c,f.tail=g.next={}}return this}function b(a,b,c){var d,e,f;if(!a)delete this._callbacks;else if(e=this._callbacks){a=a.split(/\s+/);while(d=a.shift()){f=e[d],delete e[d];if(!b||!f)continue;while((f=f.next)&&f.next)if(f.callback!==b||!!c&&f.context!==c)this.on(d,f.callback,f.context);else continue}}return this}function c(a){var b,c,d,e,f,g,h;if(!(d=this._callbacks))return this;g=d.all,(a=a.split(/\s+/)).push(null);while(b=a.shift()){g&&a.push({next:g.next,tail:g.tail,event:b});if(!(c=d[b]))continue;a.push({next:c.next,tail:c.tail})}h=i.call(arguments,1);while(c=a.pop()){e=c.tail,f=c.event?[c.event].concat(h):h;while((c=c.next)!==e)c.callback.apply(c.context||this,f)}return this}return function(){return this.on=a,this.off=b,this.trigger=c,this}}(),e.List=function(){function a(a){return f[this._name][a]||null}function b(a){var b=0,c=f[this._name];for(var d in c)if(k.call(c,d)&&b++===a)return c[d]}function c(){return this.index(0)}function d(){var a=f[this._name],b=m.size(a);return b>0?this.index(b-1):!1}return function(){return this.first=c,this.last=d,this.iD=a,this.index=b,this}}(),e.Model=e.Class.extend("Atomy.__Model__",{_methods:{create:"POST",read:"GET",update:"PUT",destroy:"DELETE"},ajaxProvider:"superagent",fakeJSON:!1,fakeHTTP:!1,_getMethod:function(a){if(this.fakeHTTP)if(a==="update"||a==="destroy")return"POST";return this._methods[a]},idAttribute:"id",schema:[],connection:{},collection:{},errors:{},init:function(){},find:function(a,b){var c;return m.isHash(a)||(c=a!=="all"?a:null,a={}),this._crud({id:c,data:a,action:"read"},b)},findOnClient:function(a,b){!m.isHash(a)&&(a={id:a});var c=[],d=0,e,f,g=this.records();for(f in a)d+=1;if(m.isEmpty(g))return m.isFunction(b)&&b([],e),c;if(a.id==="all")c=g;else{if(!!m.isEmpty(a))throw new Error("Atomy.findOnClient: Missing query parameter");for(f in g){var h=g[f];if(m.isMatch(h,a)){c.push(h);if(d===1&&!m.isUndefined(a.id)){e=f;break}}}}return m.isFunction(b)&&b(c,e),c},create:function(a,b){return this(a).save(b)},update:function(a,b,c,d){var e,f;d=d||null,m.isHash(a)&&(c=b,b=a,a=b[this.idAttribute]);if(d)for(e in b)f=b[e],typeof d._.data!="undefined"&&d._.data[e]!==f&&(b[e]=f);return this._crud({data:b,action:"update",model:d,id:a},c)},destroy:function(a,b,c){return this._crud({action:"destroy",model:c,id:a},b)},sync:function(a,b){return this.request({url:this._getURL(a.id,a),type:this._getMethod(a.action),data:this.fakeHTTP?m.extend(a.data,{_method:this._getMethod(a.action)},!0):a.data||{},success:m.curry(this._callback,this,a,b),error:m.curry(this._callback,this,{},b),dataType:"json"},this.fakeJSON,a.action)},request:function(a,c,d){var e=this,f={zepto:"$",jquery:"$",superagent:"superagent"}[this.ajaxProvider];if(!f)throw new Error("Atomy.request: Invalid Ajax provider");return{superagent:function(){return n(a.type,a.url).type(c?"form-data":a.dataType).send(a.data).end(a.success)},$:function(){return a.beforeSend=function(a){c&&a.setRequestHeader("X-HTTP-Method-Override",e._methods[d])},b.ajax(a)}}[f]()},records:function(){return f[this._name]},toJSON:function(){var a=this.records(),b={};return a&&m.each(a,function(a,c){b[c]=a.toJSON()}),b},toArray:function(){var a=this.records(),b=[];return a&&m.each(a,function(a){b.push(a.toJSON())}),b},clearRecords:function(){return delete f[this._name],f[this._name]={}},_crud:function(a,b){var c,d;if(a.model&&a.action==="update"){var e={};a.model._updateFields("",a.data),a.data=e=a.model._diff(a.model._.data),a.model._updateFields("update",e),a.model.trigger("update",a.model,e)}if(a.model&&this.validate&&(d=a.model._validate())){var f={errors:d,error:!0,ok:!1};return a.model.trigger("error",a.model,d),m.isFunction(b)&&b.call(this,f)||f}return this.sync(a,b)},_callback:function(a,b,c,d,e){var f={},g=this.ajaxProvider==="superagent",h=g&&c&&typeof c.body!="undefined",i=d==="error",j=h?c.body:c;return h&&(f=c),f.doc=i?{}:a.model?m.extend(a.model,j):this._toModel(j),h&&delete c.body,this._sync(a.action,f.doc,a),m.isFunction(b)&&b.call(this,this._status(f,g||(i?e.status:c.status)))||f},_sync:function(a,b,c){var d=this._name,e=m.isArray(b)&&b,g=c[this.idAttribute]||b[this.idAttribute];f[d]=f[d]||{},e?a==="read"&&m.each(e,function(a){f[d][a[a.idAttribute]]=a}):a==="destroy"?(f[d][g]&&delete f[d][g],b.trigger(a,b)):this._getMethod(c.action)&&(f[d][b[this.idAttribute]]=b)},_status:function(a,b){if(this.ajaxProvider==="superagent")return a;var c=b/100|0;return a.status=b,a.statusType=c,a.info=1==c,a.ok=2==c,a.clientError=4==c,a.serverError=5==c,a.error=4==c||5==c,a.accepted=200==b,a.noContent=204==b||1223==b,a.badRequest=400==b,a.unauthorized=401==b,a.notAcceptable=406==b,a.notFound=404==b,a},_getURL:function(a){return[this.connection.host||this._getHost(),this.connection.key,a&&"/"+a||"",m.isUndefined(this.connection.ext)?"":"."+this.connection.ext].join("")},_getHost:function(){return[location.protocol,"//",location.hostname,location.port?":"+location.port:"","/"].join("")},_toModel:function(a){var b=[],c,d;if(m.isArray(a))for(c=0,d=a.length;c<d;c+=1)b[c]=this._toModel(a[c]);else b=this(a)._loadServerData(),b._isNew=!1;return b}},{setup:function(a,b){var c=this.idAttribute=this._class.idAttribute;return this._escapedFields={},this._class.schema.indexOf(c)===-1&&this._class.schema.push(c),this._={data:{}},this.connection=this._class.connection,this._isNew=!0,this._name=this._class._name,a&&this._updateFields("create",a),!this[c]&&(this[c]=m.cid()),arguments},init:function(){return this},save:function(a){return this[this.isNew()?"create":"update"](a,null,this.trigger("save",this))},create:function(a){return this._loadServerData(),this._isNew=!1,this._class._crud({action:"create",model:this,data:this._.data},a)},update:function(a,b){return m.isFunction(a)&&(b=a),this._class.update(this[this.idAttribute],a,b,this)},destroy:function(a){return this._class.destroy(this[this.idAttribute],a,this)},set:function(a){return this._updateFields("update",a),this},clone:function(){return m.clone(this)},clear:function(){var a=this._class.schema,b,d,e=d={};if(a)for(var f=0,g=a.length;f<g;f++)b=a[f],typeof this[b]!="undefined"&&(d[b]=this[b],e[b]=c,delete this[b]);return m.isEmpty(e)||this.trigger("change",this,d,e),this},isNew:function(){return this._isNew},isValid:function(){return!this._validate()},toJSON:function(a){var b,c=this._class.schema,d,e;a||(a={});for(d=0,e=c.length;d<e;d++){b=c[d];if(b!=="undefined"||typeof this[b]!="undefined")a[b]=this[b]}return a},escape:function(a){return m.escape(this[a]===null?"":""+this[a])},_validate:function(){var a,b=this._class.validate;return(a=b&&b.call(this))&&this.trigger("error",this,a),a},_loadServerData:function(){var a=this._class.schema,b,c,d=a.length;for(b=0,d=a.length;b<d;b++)c=a[b],typeof this[c]!="undefined"&&!m.isEqual(this[c],this._.data[c])&&(this._.data[c]=this[c]);return this},_updateFields:function(a,b){var c=this._class.schema,d,e,f=c.length;if(c&&b)for(d=0;d<f;d++)e=c[d],typeof b[e]!="undefined"&&(this[e]=b[e],a==="update"&&(this.trigger("change:"+e,this,this[e],this._.data[e]),this._.data[e]=b[e]));return this},_diff:function(a){if(typeof a=="undefined")return null;var b=this._class.schema,d,e,f,g={};for(d=0,f=b.length;d<f;d++)e=b[d],this.hasOwnProperty(e)&&(e in this?m.isEqual(a[e],this[e])||(g[e]=this[e]):g[e]=c),e in a||(g[e]=this[e]);return g}}),m.each(["forEach","each","map","reduce","reduceRight","filter","reject","every","any","include","invoke","max","min","sortBy","sortedIndex","toArray","size","initial","rest","shuffle","isEmpty","groupBy"],function(a){e.Model[a]=function(){return m[a].apply(m,[f[this._name]])}});var p=/^(\S+)\s*(.*)$/;e.View=e.Class.extend("Atomy.__View__",{template:"",tag:"div",events:{},interpolate:null,$:function(a){return this.$el.find(a)},setup:function(a,c){var d=a.el,f=a.model,g=a.attr,h,f,i="";return!d instanceof b&&(g=d,d=null),d instanceof e.Model&&(f=d,d=null,g={}),g instanceof e.Model&&(f=g,g={}),d=d||this.el,g=g||{},m.isString(d)&&(h=d,d=null),g.html&&(i=g.html,delete g.html),this.id&&!g.id&&(g.id=this.id),this.attr=g,this.tag=h||this.tag,d=d?d:this.create(this.tag,i),d=this.setAttr(d,g),this.setElement(d,!1),m.isArray(f)?this.models=f:this.model=f||this.model||{},this.cid=m.uniqueId("view_"),this.interpolate&&(m.templateSettings={interpolate:this.interpolate}),this.elements&&this.refreshElements(),this.delegateEvents(),arguments||[]},render:function(){return this},remove:function(){return this.$el.remove(),this},create:function(c,d){var e=a.createElement(c);return d&&b(e).html(d),e},setAttr:function(a,c){return c&&m.isHash(c)&&b(a).attr(c),a},refreshElements:function(){m.each(this.elements,function(a,b){m.isString(b)&&(this[a]=this.$(b))},this)},setElement:function(a,c){return this.$el&&this.undelegateEvents(),this.$el=a instanceof b?a:b(a),this.el=this.$el[0],c!==!1&&this.delegateEvents(),this},delegateEvents:function(a){var b,c,d=this;this.undelegateEvents();for(var e in this.events){c=this.events[e];if(m.isString(c)&&!(c=this[c]))throw new Error('Method "'+c+'" does not exist');if(m.isFunction(c)){var f=e.match(p),g=f[1],h=f[2];c=m.bind(c,this),g+=".delegateEvents"+this.cid,h===""?this.$el.on(g,c):this.$el.delegate(h,g,c)}}return this},undelegateEvents:function(){this.$el.off(".delegateEvents"+this.cid)}});var q=/msie [\w.]+/,r=/^[#\/]/,s=!1,t=a.documentMode,u=q.exec(navigator.userAgent.toLowerCase())&&(!t||t<=7),v=d.location,w="";return e.Router=e.Class.extend("Atomy.__Router__",{_ids:{},_routes:{},defaults:{root:"",interval:50,history:!1,pushState:!1,fallback:!0,hashbang:!1,listen:!0,ignoreInitialHash:!1},setup:function(a){return a=a||this.options||{},a=this.options=m.defaults(this.defaults,a),this.map(this.routes),this._hashbang=a.hashbang,this._fallback=a.fallback,this._hasPushState=!!d.history&&!!d.history.pushState,this._event=null,a.listen&&this.listen(),arguments},listen:function(){var a=this,b=function(b){var c=a.fragment();c!==w&&(a._event=b,a._check(c),w=c)};this.options.pushState&&this._hasPushState?d.onpopstate=b:this._fallback&&("onhashchange"in d&&!u?d.onhashchange=b:this._intervalTimer=setInterval(b,this.options.interval)),this.options.ignoreInitialHash||this._check(this.fragment())},fragment:function(a){return a?(a.indexOf(this.options.root)||(a=a.substr(this.options.root.length)),console.log("FRAGMENT",a,a.replace(r,"")),a.replace(r,"")):a=this.options.pushState&&this._hasPushState?v.pathname:this.hash()},hash:function(a){var b=a?a.location:v,c=b.href.match(/#!?(.*)$/);return c?c[1]:""},map:function(a,b){if(m.isHash(a))for(var c in a)this.map(c,a[c]);else{if(!a)return this;var d=a.split(" ");this._routes[d[0]]=b,d[1]&&(this._ids[d[1]]=d[0])}return this},navigate:function(a,b){return b===!0&&(b={trigger:!0}),this._pushState(a),b&&b.trigger&&this._check(a),this},redirect:function(a){window.location=a},_pushState:function(a){this.options.pushState&&this._hasPushState?history.pushState(null,null,a):this._fallback&&(v.hash=["#",this._hashbang?"!":"",a].join(""))},_check:function(a){var b,c;for(b in this._routes)if(k.call(this._routes,b)){c=this._routes[b],m.isString(c)&&(c=this[c]);if(this._run(b,a,c))return}},_run:function(a,b,c){var d=[],e,a=this._regex(a,d).exec(b);return c&&(e=a?this._params(d,a):null)?((m.isString(c)&&this[c]||c).call(this,e.obj,e),!0):!1},_regex:function(a,b,c){return a=a.concat(c?"":"/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(a,c,d,e,f,g){return b.push({name:e,optional:!!g}),c=c||"",[g?"":c,"(?:",g?c:"",d||"",f||d&&"([^/.]+?)"||"([^/]+?)",")",g||""].join("")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)"),new RegExp("^"+a+"$")},_params:function(a,b){var c,d,e={path:b[0],names:a,values:b,obj:{}};if(b)for(c=1,d=b.length;c<d;c++)e.obj[a[c-1].name]=b[c];return e}}),e.List.call(e.Model),e.Events.call(e.Model),e.Events.call(e.View.prototype),e.Events.call(e.Model.prototype),e}).call(this,document,window.jQuery||window.Zepto||undefined)